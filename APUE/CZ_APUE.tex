\documentclass{ctexart}
\usepackage{xcolor}
\definecolor{commentgreen}{RGB}{2,112,10}
\definecolor{eminence}{RGB}{108,48,130}
\definecolor{weborange}{RGB}{255,165,0}
\definecolor{frenchplum}{RGB}{129,20,83}

\usepackage{listings}
\lstset {
    language=C++,
    %frame=tblr,
    tabsize=4,
    showstringspaces=false,
    %numbers=left,
    %upquote=true,
    commentstyle=\color{commentgreen},
    keywordstyle=\color{eminence},
    stringstyle=\color{red},
    basicstyle=\ttfamily, % basic font setting
    emph={int,char,double,float,unsigned,void,bool},
    emphstyle={\color{blue}},
    escapechar=\&,
    % keyword highlighting
    classoffset=1, % starting new class
    otherkeywords={>,<,.,;,-,!,=,~},
    morekeywords={>,<,.,;,-,!,=,~},
    keywordstyle=\color{weborange},
    classoffset=0,
    breaklines=true
}

\lstnewenvironment{fun}{\lstset{language=C,frame=tblr}}{}

\newcommand{\io}{I/O}
\newcommand{\cod}[1]{\lstinline!#1!}
\newcommand{\funame}{\cod}
\newcommand{\const}{\cod}
\newcommand{\param}[1]{{\itshape #1}}
\newcommand{\struct}{\cod}
\newcommand{\clname}[2]{\struct{#1} \cod{#2}}
\title{APUE笔记}
\author{C.Z.}
\begin{document}
  \maketitle
  \section{文件I/O}
  \section{文件和目录}
  \subsection{引言}
    本章描述文件系统的其他特征，文件的各种属性以及对目录的操作。
  \subsection{函数stat、fstat、fstatat和lstat}
  \begin{fun}[cc]
    #include <sys/stat.h>
    int stat(const char *restrict pathname, struct stat *restrict buf);
    int fstat(int fd, struct stat *buf);
    int lstat(const char *restrict pathname, struct stat *restrict buf);
    int fstat(int fd, const char *restrict pathname, struct stat *restrict buf, int flag);
    // 若成功，返回0；若出错，返回-1
  \end{fun}
  \par
  四个函数说明如下：
  \begin{enumerate}
    \item \funame{stat}返回与此文件名有关的信息结构；
    \item \funame{fstst}返回与已打开在描述符\param{fd}上的文件的有关信息；
    \item \funame{lstat}于符号连接返回符号连接本身的信息而非指向文件的信息；
    \item \funame{fstatat}返回相对于\param{fd}的\param{pathname}的文件信息。\\ \param{flag} \const{|AT_SYMLINK_NOFOLLOW}则同\funame{lstat}，否则同\funame{stat}。\\ \param{flag} \const{|AT_FDCWD}（fd current working directory）则视\param{pathname}是否为绝对路径名决定直接前往该路径还是前往基于当前工作目录的相对路径。
  \end{enumerate}
  \par
  参数\param{buf}是一个指针，指向结构的基本形式为
  \begin{fun}
    struct stat {
      mode_t          st_mode; /* 文件类型，许可 */
      uid_t           st_uid;  /* 所有用户ID */
      gid_t           st_gid;  /* 所有组ID */
      struct timespec st_atime;/* 访问时间 */
      struct timespec st_mtime;/* 修改时间 */
      struct timespec st_ctime;/* 属性改变时间 */
    }
  \end{fun}
  其中\struct{timespec}至少包含
  \begin{fun}
    struct timespec {
      time_t tv_sec;
      long tv_nsec;
    }
  \end{fun}
  \subsection{文件类型}
  UNIX系统文件类型包括
  \begin{enumerate}
    \item 普通文件（regular file），无论文本或二进制数据；宏：\cod{S\_ISREG}；
    \item 目录文件（directory file），包含了其他文件的名字以及指向与这些文件有关信息的指针。读需要对目录文件的读权限，写只有内核可以；宏：\cod{S\_ISDIR}；
    \item 块特殊文件（block special file），提供对设备带缓冲，固定长度的访问；宏：\cod{S\_ISCHR}；
    \item 字符特殊文件（character speical file），提供不带缓冲，可变长度的访问。设备要么是它，要么是前者；宏：\cod{S\_ISBLK}；
    \item FIFO，用于进程间通信；宏：\cod{S\_ISFIFO}；
    \item 套接字（socket），用于进程间的网络通信，亦可以非网络通信；宏：\cod{S\_ISLNK}；
    \item 符号链接（symbolic link），指向另一文件。宏：\cod{S\_ISSOCK}；
  \end{enumerate}
  上述宏接收\clname{mode_t}{st_mode}，返回\struct{bool}。其本质为诸如\cod{(mode & S_IFMT) == S_IFDIR}的位测试。
  \par
  还有如下三个以\struct{stat}为输入的宏分别检测消息队列、信号量和共享储存对象，虽然它们不是文件：\cod{S_TYPEISMQ}，\cod{S_TYPEISSEM}和\cod{S_TYPEISSHM}。
  \subsection{设置用户ID与设置组ID}
  与进程关联的ID如下：
  \begin{enumerate}
    \item 实际用户ID与实际组ID：实际身份，取自登陆时口令文件的登录项；
    \item 有效用户ID、有效组ID与附属组ID：决定了文件访问权限，通常同实际ID；
    \item 保存的设置用户ID与保存的设置组ID：有效ID的副本；
  \end{enumerate}
  \par
  与文件关联的ID由\clname{uid_t}{st_uid}和\clname{gid_t}{st_gid}获取。若\clname{mode_t}{st_mode}设定了设置用户ID（set-user-ID）位或设置组ID（set-group-ID）位，则可以在执行该文件时以所有者ID为有效ID。
\end{document}